#!/bin/bash

# Script: kubctl-0x01
# Purpose: Scale Django app deployment, verify pods, test load, and monitor usage

APP_NAME="messaging-app"  # Change if your deployment name is different
REPLICAS=3

echo "ğŸ“¦ Scaling deployment '$APP_NAME' to $REPLICAS replicas..."
kubectl scale deployment "$APP_NAME" --replicas=$REPLICAS

echo "â³ Waiting for pods to be ready..."
sleep 10  # Give time for pods to spin up

echo "ğŸ” Checking running pods..."
kubectl get pods -l app="$APP_NAME"  # Assumes label 'app=messaging-app'

echo "ğŸŒ Starting Minikube tunnel in background (if needed for service access)..."
(minikube tunnel &)

echo "ğŸŒ Finding service NodePort or ClusterIP..."
kubectl get services

# Optionally retrieve the service IP and port if needed
# EXTERNAL_IP=$(minikube service "$APP_NAME" --url)

echo "ğŸ§ª Performing load test using wrk..."
echo "Make sure wrk is installed. Example target: http://localhost:8000/"
wrk -t2 -c100 -d15s http://localhost:8000/

echo "ğŸ“Š Monitoring resource usage..."
kubectl top pods

echo "âœ… Done!"
